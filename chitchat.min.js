var ChitChat=ChitChat||{};ChitChat.Packet=function(a){this.who=a?a.who:void 0;this.type=a?a.type:void 0;this.message=a?a.message:void 0;this.op=a?a.op:void 0};ChitChat.Provider=function(){this.id="parent";this.consumers=[];this.origin=void 0;this.demosite="chitchat_consumer.html";this.init()};
ChitChat.Provider.prototype={init:function(){this.listener()},addConsumer:function(a){new ChitChat.Packet;var b;b=$("#"+a.data.message).get(0).contentWindow;this.consumers.push({name:a.data.message,frame:b,origin:a.origin});this.sendUpdatedConsumers()},removeConsumer:function(a){var b=this.findConsumer(a);if(-1!==b&&this.consumers[b])return this.consumers.splice(b,1),$("#"+a).remove(),console.info(a+" removed"),!0;console.error(a+" not found in provider register");return!1},findConsumer:function(a){var b=
this.consumers.length,c;for(c=0;c<b;c++)if(this.consumers[c].name===a)return this.consumers[c];return!1},msgToConsumer:function(a){var b=this.findConsumer(a.data.who),c=new ChitChat.Packet({who:a.data.who,message:a.data.message,type:"c2c"});b?b.frame.postMessage(c,b.origin):console.error("Couldnt find destination consumer: "+a.data.who)},msgToConsumers:function(a){a=new ChitChat.Packet({type:"c2e",message:a.data.message,op:a.data.op||""});for(var b=this.consumers.length,c=0,c=0;c<b;c++)this.consumers[c].frame.postMessage(a,
this.consumers[c].origin)},msgToFramework:function(){},msgToParent:function(a){$("#log").text(a)},listener:function(){window.addEventListener("message",this.parseMessage,!1)},createConsumer:function(){var a=$("#iframe-template").html(),b=Handlebars.compile(a),a={nextframe:this.consumers.length+1,src:this.demosite},b=b(a);$("body").append(b);$("#consume"+a.nextframe).draggable({grid:[20,20],handle:"div"})},sendUpdatedConsumers:function(){var a=[],b=this.consumers.length,c=new ChitChat.Packet,d;for(d=
0;d<b;d++)a.push(this.consumers[d].name);c.type="update";c.message=a;for(d=0;d<b;d++)this.consumers[d].frame.postMessage(c,this.consumers[d].origin)},parseMessage:function(a){switch(a.data.type){case "reg":provider.addConsumer(a);break;case "c2e":provider.msgToConsumers(a);break;case "c2c":provider.msgToConsumer(a);break;case "c2p":provider.msgToParent(a.data.message);break;case "c2f":provider.msgToFramework(a.data.message);break;default:console.error("Incorrect message type from consumer")}}};
ChitChat.Consumer=function(){this.name=window.frameElement.id;this.who=void 0;this.messageBox=$("message");this.peers=[];this.init()};
ChitChat.Consumer.prototype={init:function(){this.listeners();this.registerWithProvider()},updateConsumerList:function(a){var b=a.length,c;this.peers=a;$("#consumers").empty();for(c=0;c<b;c++)$("#consumers").append($("<option></option>").attr("value",a[c]).text(a[c]))},registerWithProvider:function(){var a=new ChitChat.Packet({type:"reg",message:window.frameElement.id});this.sendMessage(a)},sendMessage:function(a){window.parent.postMessage(a,"http://localhost")},msgEveryone:function(a){a=new ChitChat.Packet({type:"c2e",
message:a});this.sendMessage(a)},msgCustom:function(a){this.sendMessage(a)},msgFramework:function(a){a=new ChitChat.Packet({type:"c2f",message:a});this.sendMessage(a)},msgConsumer:function(a,b){var c=new ChitChat.Packet({type:"c2c",who:a,message:b});this.sendMessage(c)},msgParent:function(a){var b=new ChitChat.Packet;b.type="c2p";b.message=a;this.sendMessage(b)},listeners:function(){window.addEventListener("message",this.getParentMessage,!1)},onSelectChange:function(){var a=$("#consumers option:selected").text();
consumer.msgConsumer(a,"msg from "+consumer.name)},getParentMessage:function(a){"update"===a.data.type?($("#log").text("parent update received"),consumer.updateConsumerList(a.data.message)):"select"===a.data.op?($("#log").text(a.data.message),"function"==typeof localFunc&&localFunc(a.data.message)):$("#log").text(a.data.message)}};